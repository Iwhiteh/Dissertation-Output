---
title: 'Dissertation'
output: 
  html_document:
    toc: true
    number_sections: true
    code_folding: hide
date: "2022-10-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE) #doesn't show code or error messages in knit
```

```{r library, message=FALSE, include=FALSE} 
#don't print outputs
library(dplyr)
library(tidyverse) 
library(knitr)
library(readr)
library(ggplot2)
library(bbmle)
library(mizer) 
library(Hmisc)
library(lme4)
library(RColorBrewer)
library(viridis)

get_density <- function(x, y, ...) {
  dens <- MASS::kde2d(x, y, ...)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}
```

```{r block, message=FALSE, include=FALSE}
(load("stomach_dataset.Rdata")) #change to access via github repository
#the dataset is already named stom_df
stom_df
df <- stom_df %>% transmute(haul_id, latitude, longitude, ices_rectangle, year, pred_species, pred_weight_g, pred_length_cm, prey_species, prey_weight_g, prey_type = prey_funcgrp, indiv_prey_weight = prey_ind_weight_g, no._prey_per_stmch = prey_count / n_stomachs, ppmr) 
df
#ices_rectangle accounts for location of points
```

```{r cleaning smaller, message=FALSE, include=FALSE}
df_fixed <- df[df$indiv_prey_weight != 0, ]
df_fixed <- df_fixed[df_fixed$pred_weight_g != 0, ]
df_fixed <- df_fixed[df_fixed$indiv_prey_weight != Inf, ]

#a smaller (random) sample of the overall data set
#to check errors:
#anyNA(renamed_df_small$ppmr)
#any(renamed_df_small$ppmr == 0)

renamed_df = df_fixed %>% 
  mutate(pred_species = replace(pred_species, pred_species == "Clupea harengus", "Herring")) %>% 
  mutate(pred_species = replace(pred_species, pred_species == "Sprattus sprattus", "Sprat")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Gadus morhua", "Cod")) %>% 
  mutate(pred_species = replace(pred_species, pred_species == "Melanogrammus aeglefinus", "Haddock")) %>% 
  mutate(pred_species = replace(pred_species, pred_species == "Merlangius merlangus", "Whiting")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Micromesistius poutassou", "Blue Whiting")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Trisopterus esmarkii", "Norway Pout")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Trisopterus minutus", "Poor Cod")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Merluccius merluccius", "European Hake")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Lophius piscatorius", "Monkfish")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Trachurus trachurus", "Horse Mackerel")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Scomber scombrus", "Mackerel")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Limanda limanda", "Common Dab")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Pleuronectes platessa", "Plaice")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Lepidorhombus whiffiagonis", "Megrim")) %>%
  mutate(pred_species = replace(pred_species, pred_species == "Solea solea", "Sole")) %>% 
  mutate(pred_species = replace(pred_species, pred_species == "Capros apers", "Boarfish"))

species_list <- list("Herring", "Sprat", "Cod", "Haddock", "Whiting", "Blue Whiting", "Norway Pout", "Poor Cod", "European Hake", "Monkfish", "Horse Mackerel", "Mackerel", "Common Dab", "Plaice", "Megrim", "Sole", "Boarfish")

renamed_df <- renamed_df[renamed_df$pred_species %in% species_list, ]

renamed_df$lppmr <- log(renamed_df$ppmr)
#adding a column of log(ppmr) values
renamed_df$lprey_weight <- log(renamed_df$indiv_prey_weight)
renamed_df$lpred_weight <- log(renamed_df$pred_weight_g)

#to change to bigger df, just remove the bit below
#renamed_df <- renamed_df[1:5000,]
#renamed_df <- renamed_df[sample(nrow(df), 5000), ]
```

# Distribution of prey type eaten for each predator

```{r r distribution of prey, echo = TRUE}
ggplot(renamed_df, aes(x=prey_type, fill=prey_type)) +
  geom_bar(stat="count", width=0.7) +
  facet_wrap(~renamed_df$pred_species, scale="free_y") +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())  +
  scale_fill_brewer(palette = "Dark2")

#'theme()' removes any words on the x-axis so the graphs are easier to understand
#scale_fill_brewer means the colours are easy to distinguish between
```

These are individual bar charts showing the distribution of the type of prey each predator eats.

Benthos: organisms that live on/near the bottom of a body of water
Fish: aquatic, craniate (have a skull), gill-bearing animals that lack limbs with digits (i.e. their limbs don't have toes or fingers)
Nekton: the actively swimming aquatic organisms
Other: misc. types that don't fit into the other categories
Zooplankton: animal plankton (plankton are aquatic organisms that are unable to swim effectively against currents)

# Ave PPMR for individual species, weighted by prey biomass:
```{r ave PPMR biomass, echo = TRUE}
#Separated into individual plots for each predator species -> using facet_wrap for the variable (pred_species)
ggplot(data = renamed_df, aes(x=lppmr), group=1) + 
  labs(title = "log(PPMR) v. biomass density of prey", x="log(PPMR)", y="Biomass density of prey") +
  facet_wrap(~renamed_df$pred_species, scale="free_y") + 
  theme(strip.text = element_text(size = 5)) +
  geom_density(aes(weight = prey_weight_g), colour="red")
#geom_density means area under the curve = 1

#poor cod and boarfish?
``` 

Looking for the most common log(PPMR) for each individual species.

A graph of the log(ppmr) (weighted by prey biomass density) for each species against the biomass density of the prey.

# Ave PPMR for individual species, weighted by number of prey:
```{r ave PPMR prey no., echo = TRUE}
#Separated into individual plots for each predator species -> using facet_wrap for the variable (pred_species)
ggplot(data = renamed_df, aes(x=lppmr), group=1) + 
  labs(title = "Scatter plot: log(PPMR) v. number density of prey", x="log(PPMR)", y="Number density of prey") +
  facet_wrap(~renamed_df$pred_species, scale="free_y") + 
  theme(strip.text = element_text(size = 5)) +
  geom_density(aes(weight = no._prey_per_stmch), colour="red")
```

Looking for the most common log(PPMR) for each individual species.

A graph of the log(ppmr) (weighted by number of prey) for each species against the number density of the prey.

# Specific PPMR calculations by different weightings for Herring species

```{r Herring PPMR setup, echo = TRUE}
herringDF <- renamed_df %>% 
    filter(pred_species == fixed("Herring"))
#separate data set of a single species - Herring
```

## No weighting

```{r No weighting, echo = TRUE} 
#No weighting
herringmean = mean(herringDF$lppmr)
herringSD = sqrt(var(herringDF$lppmr))
print(paste("Non-weighted mean", herringmean))
print(paste("Standard deviation of this:", herringSD))
#these are non-weighted means
#var is variance, i.e. ave. distance from each point to the mean
#mean is the arithmetic mean of log(ppmr)

ggplot(data = herringDF, aes(x=lppmr), group=1) + 
          labs(title = "log(ppmr) against biomass density for Herring", x="log(PPMR)", y="density of observations") +
          geom_density(colour="red") + 
          theme(plot.title = element_text(size=15)) + 
          stat_function(fun = dnorm, args= with(herringDF, c(mean = herringmean, sd = herringSD)))
```

## Weighted by prey biomass

```{r Prey biomass weighting, echo = TRUE} 
#Weighted by prey biomass
bio_herringmean = weighted.mean(herringDF$lppmr, w = herringDF$prey_weight_g, na.rm = TRUE)
bio_herringSD = sqrt(wtd.var(herringDF$lppmr, w = herringDF$prey_weight_g, na.rm = TRUE))
print(paste("log(ppmr) mean, weighted by biomass of prey:", bio_herringmean))
print(paste("Standard deviation of this:", bio_herringSD))

ggplot(data = herringDF, aes(x=lppmr), group=1) + 
          labs(title = "log(ppmr) against biomass density for Herring, weighted by prey biomass 
               (with a normal distribution, weighted by prey biomass)", x="log(PPMR)",y="Biomass density of observations") +
          geom_density(aes(weight = prey_weight_g), colour="blue") + 
          theme(plot.title = element_text(size=15)) + 
          stat_function(fun = dnorm, args= with(herringDF, c(mean = bio_herringmean, sd = bio_herringSD)))
```

## Weighted by number of prey

```{r No of prey weighting, echo = TRUE} 
#Weighted by number of prey
no_herringmean = weighted.mean(herringDF$lppmr, w = herringDF$no._prey_per_stmch, na.rm = TRUE)
no_herringSD = sqrt(wtd.var(herringDF$lppmr, w = herringDF$no._prey_per_stmch, na.rm = TRUE))
print(paste("log(ppmr) mean, weighted by number of observations:", no_herringmean))
print(paste("Standard deviation of this:", no_herringSD))
#weighted standard deviation found using the weighted variance
#mean and standard deviation, weighted by the number of prey

ggplot(data = herringDF, aes(x=lppmr), group=1) + 
          labs(title = "log(ppmr) against number density for Herring, weighted by no. of prey 
               (with a normal distribution, 
               weighted by number of prey per stomach)", x="log(PPMR)", y="No. density of observations") +
          geom_density(aes(weight = no._prey_per_stmch), colour="red") + 
          theme(plot.title = element_text(size=15)) +
          stat_function(fun = dnorm, args= with(herringDF, c(mean = no_herringmean, sd = no_herringSD)))
```

## Combined graph

```{r Herring combined graph, echo = TRUE} 
#combined graph of weighted by biomass and by number density
ggplot(data = herringDF, aes(x=lppmr), group=1) + 
          labs(title = "log(ppmr) against biomass/number density for Herring,
               with different weightings",
               x="log(PPMR)", y="Number/biomass density of observations") +
          geom_density(aes(weight = no._prey_per_stmch, colour="prey biomass")) + 
          geom_density(aes(weight = prey_weight_g, colour="number of prey per stomach")) + 
          theme(plot.title = element_text(size=15)) +
          scale_color_manual(name='Weightings',
                     breaks=c('prey biomass', 'number of prey per stomach'),
                     values=c('prey biomass'='blue', 'number of prey per stomach'='red'))
```

Plotting the distribution of Herring log(PPMR) as weighted by prey biomass and number of prey (with weighted normal distribution curves plotted over the top of each).

1. No weighting
2. Weighted by prey biomass
3. Weighted by number of prey per stomach

The fourth graph is the two differently weighted log(ppmr) v density graphs plotted over each other.

Prey biomass weighted mean: 6.629177
No. of prey weighted mean: 13.54102

The mean is shifted by 6.911843.

What does this mean?

# Prey weight v. number density of prey
```{r indiv_prey_weight v. no. density of prey, echo = TRUE}
ggplot(data = renamed_df, aes(lprey_weight, no._prey_per_stmch)) + 
  labs(title = "log(prey weight) v. number of prey per predator stomach", x="log(prey weight)", y="No. of prey per predator stomach") + 
  geom_point(size=0.5)
#Some interesting results --> introduce colours to show ships  

renamed_df$'haul_id_short' <- gsub("\\-.*", "", renamed_df$'haul_id')
renamed_df$'haul_id_short' <- gsub("_", "", renamed_df$'haul_id_short')
#rename haul_id values -> separate by ship names (e.g. CLYDE) rather than complete id (e.g. CLYDE-1935-6)

haul_list <- unique(renamed_df$haul_id_short)

interesting_haul <- filter(renamed_df, haul_id_short=='CLYDE'|haul_id_short=='END04'|haul_id_short=='LUC'|haul_id_short=='HIDDINK'|haul_id_short=='EXCmacDATSTO815'|haul_id_short=="Excmacdatsto815error")

haul_list_interesting <- unique(interesting_haul$haul_id_short)

ggplot (data = interesting_haul, aes(x=logprey_weight, y=no._prey_per_stmch)) + 
  labs(title = "log(prey weight) v. number of prey per stomach - separated by ship names", x="log(prey weight)", y="No. prey per stomach") + 
  geom_point(size=0.01, colour="red") +
  theme(strip.text = element_text(size = 5)) + facet_wrap(~interesting_haul$haul_id_short, scale="free_y")
```

Playing around with data to see any specific correlations; what is the distribution of the weight of prey recorded.

1. Prey weight v. no. prey per stomach
2. Log (prey weight) v. no. prey per stomach -> showed some interesting results, so added colours to identify individual ships
3. Graph 2., but with points from each ship plotted on separate graphs -> note y prop. to e^-x relation for END04 (i.e. no. per stomach is proportional to 1/prey weight); lots of observations for single weights for LUC and CLYDE; lots of the same no. of fish observations for HIDDINK.

Also, I found that the EXCmacDATSTO815 and Excmacdatsto815error gave exactly the same data (which might need to be considered in later calculations).


# Prey weight v. Predator weight

```{r prey weight v. pred weight, echo = TRUE}
ggplot (data = renamed_df, aes(indiv_prey_weight, pred_weight_g)) +
  geom_point(size=0.5) + 
  labs(title = "Predator v. prey mass plot", x="Prey mass (g)", y="Predator mass (g)")
#mass since measured in g

renamed_df$density <- get_density(renamed_df$lprey_weight, renamed_df$lpred_weight, n = 100)

ggplot(data = renamed_df, aes(lprey_weight, lpred_weight, color=density)) + 
  geom_point(size=0.5) + 
  labs(title = "log(Predator mass) v. log(prey mass) plot", x="log(Prey mass)", y="log(Predator mass)") + 
  stat_smooth (method='lm', se=FALSE, colour="red")
  

slope <- coef(lm(renamed_df$lpred_weight~renamed_df$lprey_weight))
print(paste("slope of the log(pred) v. log(prey) line of best fit:", slope[2]))

ggplot(data = renamed_df, aes(lprey_weight, lpred_weight)) + 
  labs(title = "log(pred. mass) v. log(prey mass) separated by predator species", x="log(prey mass)", y="log(pred. mass)") +
  geom_point(size=0.2) + 
  facet_wrap(~pred_species, scale="free_y") + 
  theme(strip.text = element_text(size = 10)) +
  stat_smooth (method='lm', se=FALSE, colour="red")
```

1. Prey weight v. predator weight -> attempting to find a link between the predator mass and the prey mass  
2. log(prey weight) v. log(pred. weight) ->  using log() to see proportionality of the axes, slope of added line should = PPMR  
3. Looking to find correlation between the masses for each individual species; the slope should have gradient=1, else our idea for PPMR calculation (pred mass is prop. to prey mass) is incorrect. 

log(pred weight) = mlog(prey weight) + C
Hence, pred weight = e^(mlog(preyweight) + log(D)) (where C=log(D))
Therefore,
pred weight = (prey weight)^m * D -> we want m=1 for pred weight proportional to prey weight.

# Predator weight v. ppmr
```{r pred weight v. ppmr, echo = TRUE}
ggplot(data=renamed_df, aes(lpred_weight, lppmr)) + 
  geom_point(size=0.001) +
  labs(title = "log(pred mass) v. log(ppmr) plot", x="log(Pred mass)", y="log(PPMR)") + 
  stat_smooth (method='lm', se=FALSE) + 
  facet_wrap(~pred_species, scale="free_y")

#Focusing in on just poor cod
species_df <- renamed_df %>% filter(pred_species == fixed("Poor Cod"))

ggplot(data=species_df, aes(lpred_weight, lppmr)) + 
  geom_point(size=0.5) +
  labs(title = "log(pred mass) v. log(ppmr) plot: Poor Cod", x="log(Pred mass)", y="log(PPMR)") + 
  facet_wrap(~pred_species, scale="free_y") + 
  stat_smooth(method=lm)

species_slope <- coef(lm(species_df$lppmr~species_df$lpred_weight))
print(paste("slope of the log(ppmr) v. log(pred_weight) line of best fit for poor cod:", species_slope[2]))
```

Graphing log(pred mass) v. log(ppmr) for individual predator species to see if predator mass related to the ppmr.

i.e. we want them to not be proportional (i.e. slope = 0) to prove that log(predator mass) is not related to the log(ppmr) (and hence the ppmr is independent of the predator mass for a certain species).

First, plot graphs of log(pred mass) v. log(ppmr) for each individual predator species, with line of best fit on each graph

Looking at just the predator species 'poor cod'.
This graph includes a region of error for the line of best fit .

CHECK: IS THIS NO. OF POINTS RECORDED OR NO. POINTS*NO. PREY PER STOMACH
HOW TO ADD THE UNCERTAINTY IN THE LOBF

# Introducing a mixed effects model

```{r first mixed effects, echo=TRUE}
#fixed: pred_species and prey_weight_g
#random: haul_id_short
m <- lmer(lppmr ~ pred_species + prey_weight_g + (1|haul_id_short), data = renamed_df)

lmer(lppmr ~ pred_species + prey_weight_g + (1|haul_id_short), data = renamed_df, REML=FALSE)

#ggplot(fortify(m), aes(prey_weight_g, log(ppmr),  color=pred_species)) +
  stat_summary(fun.data=mean_se, geom="pointrange") +
  stat_summary(aes(y=.fitted), fun.y=mean, geom="line")

#anova (nullmodel1, nullmodel2, nullmodel3)
#To find which of 3 potential models have the 'best fitting' random effects structure

#fixed: pred_species and prey_weight_g
#random: haul_id_short, year, no._prey_per_stmch, ices_rectangle
lmer(lppmr ~ pred_species + prey_weight_g + (1|haul_id_short) + (1|year) + (1|no._prey_per_stmch) + (1|ices_rectangle), data = renamed_df)

#Generally: lmer(fixed ~ (1|random) + linear)
#(1|...) means accounting for for random intercepts (varying baseline levels) in your variable.
#(0|...) means the variable has a fixed intercept and not a random one
#e.g. (1|year) means random intercepts and slopes for year (different baselines, different average effect per year).
#REML = FALSE?
```

Fixed effect: log(ppmr) (the main effect we are tracking)

Random effects: haul_id_short, year

Linear (fixed) effects: pred_species, prey_weight_g (what we assume will affect the fixed effect)
